<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>üöÄ WorldLink Network Testnet</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>

    body {

      background-color: #000;

      color: cyan;

      text-align: center;

      font-family: Arial, sans-serif;

      padding-top: 60px;

    }

    button {

      background-color: #ffcc00;

      border: none;

      border-radius: 6px;

      padding: 12px 24px;

      margin: 8px;

      cursor: pointer;

      font-weight: bold;

      opacity: 0.6;

      pointer-events: none;

      transition: all 0.3s ease;

    }

    button.enabled {

      opacity: 1;

      pointer-events: auto;

    }

    #status {

      margin-top: 30px;

      font-size: 18px;

    }

  </style>

</head>

<body>

  <h1>üöÄ WorldLink Network Testnet is Live!</h1>

  <p>Connected to Pi Testnet via Express Server</p>



  <button id="loginButton">Login with Pi</button>

  <button id="payButton">Pay with Pi</button>



  <p id="status">üîç Checking Pi SDK...</p>



  <script>

    let userAuth = null;

    const statusEl = document.getElementById("status");



    // ‚úÖ B·∫Øt l·ªói to√†n c·ª•c ƒë·ªÉ tr√°nh frozen

    window.onerror = (msg, url, line, col, err) => {

      console.error("‚ö†Ô∏è JS Error:", msg, line, col);

      statusEl.innerHTML = "‚ö†Ô∏è JS Error: " + msg;

    };



    // ‚úÖ K√≠ch ho·∫°t n√∫t

    function enableButtons() {

      document.querySelectorAll("button").forEach((b) => b.classList.add("enabled"));

    }



    window.onload = async () => {

      if (typeof Pi === "undefined" || !Pi.init) {

        statusEl.innerHTML =

          "‚ö†Ô∏è Pi SDK not detected.<br>Open this site in <b>Pi Browser</b>.";

        return;

      }



      // üîß Init SDK (sandbox = true v√¨ testnet)

      Pi.init({ version: "2.0", sandbox: true });

      console.log("‚úÖ Pi SDK initialized");

      statusEl.textContent = "‚úÖ Pi SDK detected successfully.";

      enableButtons();



      // üü° LOGIN

      document.getElementById("loginButton").addEventListener("click", async () => {

        try {

          statusEl.textContent = "üîë Logging in...";

          const scopes = ["username", "payments"]; // üß© c√≥ "payments" scope ƒë·ªÉ payment ho·∫°t ƒë·ªông

          const auth = await Pi.authenticate(scopes, (payment) => {

            console.log("üí¨ Payment callback:", payment);

          });



          userAuth = auth;

          console.log("‚úÖ Login success:", auth);

          statusEl.textContent = "‚úÖ Logged in as @" + auth.user.username;

        } catch (err) {

          console.error("‚ùå Login failed:", err);

          statusEl.textContent = "‚ùå Login failed: " + (err.message || err);

        }

      });



      // üí∞ PAYMENT

      document.getElementById("payButton").addEventListener("click", async () => {

        if (!userAuth) {

          statusEl.textContent = "‚ö†Ô∏è Please login first!";

          return;

        }



        try {

          statusEl.textContent = "üí∞ Creating Pi Test Payment...";



          const payment = await Pi.createPayment(

            {

              amount: 1,

              memo: "WorldLink Testnet Payment",

              metadata: { source: "demo" },

            },

            {

              onReadyForServerApproval: (paymentId) => {

                console.log("üü° Ready for approval:", paymentId);

              },

              onReadyForServerCompletion: (paymentId, txid) => {

                console.log("‚úÖ Completed:", paymentId, txid);

                statusEl.textContent = "‚úÖ Payment confirmed!";

              },

              onCancel: (reason) => {

                console.warn("‚ùå Cancelled:", reason);

                statusEl.textContent = "‚ùå Payment cancelled.";

              },

              onError: (error) => {

                console.error("‚ö†Ô∏è Payment error:", error);

                statusEl.textContent = "‚ö†Ô∏è Payment failed: " + (error.message || error);

              },

            }

          );



          // G·ª≠i payment t·ªõi backend x·ª≠ l√Ω test

          await fetch("/api/complete_payment", {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify(payment),

          });

        } catch (err) {

          console.error("‚ùå Payment error:", err);

          statusEl.textContent = "‚ùå Payment error: " + (err.message || err);

        }

      });

    };

  </script>

</body>

</html>

